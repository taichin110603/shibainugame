<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Áä¨„Çπ„Ç§„Ç´„Ç≤„Éº„É† üê∂</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
body, html {
  margin:0;
  overflow:hidden;
  width:100%;
  height:100%;
  background:linear-gradient(#ffe8c7,#ffd6a5);
  font-family:sans-serif;
}

#scoreBox{
  position:absolute;
  top:22%;
  right:8%;
  font-size:20px;
}

#rankingBox{
  position:absolute;
  top:5%;
  left:8%;
  width:220px;
  font-size:16px;
  line-height:1.6em;
}

#gameOver{
  position:absolute;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  display:none;
}

#gameOver h1{
  color:red;
  font-size:50px;
}

#retryBtn{
  padding:10px 25px;
  font-size:18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#ff595e;
  color:white;
}
</style>
</head>
<body>

<div id="scoreBox">
  <div>Score : <span id="score">0</span></div>
  <div>High : <span id="highScore">0</span></div>
</div>

<div id="rankingBox">
  <div><b>Êú¨Êó•„ÅÆ„É©„É≥„Ç≠„É≥„Ç∞</b></div>
  <div id="ranking"></div>
</div>

<div id="gameOver">
  <h1>GAME OVER</h1>
  <button id="retryBtn">Retry</button>
</div>

<script>
const {Engine, Render, Runner, World, Bodies, Body, Events} = Matter;

// Âà§ÂÆöÔºö„Çπ„Éû„Éõ„ÅãPC„Åã
const isMobile = window.innerWidth <= 768;

// ÁîªÈù¢„Çµ„Ç§„Ç∫
const width = window.innerWidth;
const height = window.innerHeight;

// ÂÆπÂô®„Çµ„Ç§„Ç∫„Å®‰ΩçÁΩÆ
const containerWidth  = isMobile ? 500 : 420;  // „Çπ„Éû„ÉõÁâà„ÅØ„Åï„Çâ„Å´Â§ß„Åç„Åè
const containerHeight = isMobile ? 650 : 520;  // „Çπ„Éû„ÉõÁâà„ÅØ„Åï„Çâ„Å´Â§ß„Åç„Åè
const wallThickness   = 10;
const centerX         = width / 2;
const bottomY         = isMobile ? height * 0.85 : height * 0.9;

// Matter.js „Ç®„É≥„Ç∏„É≥
const engine = Engine.create();
engine.world.gravity.y = 1;
engine.positionIterations = 15; // Ë°ùÁ™ÅÁ≤æÂ∫¶„Ç¢„ÉÉ„Éó
engine.velocityIterations = 15; // È´òÈÄüËêΩ‰∏ãÈò≤Ê≠¢
const world = engine.world;

// „É¨„É≥„ÉÄ„É©„Éº
const render = Render.create({
  element: document.body,
  engine: engine,
  options:{
    width: width,
    height: height,
    wireframes:false,
    background:"transparent"
  }
});
Render.run(render);
Runner.run(Runner.create(), engine);

//////////////////////////////////////////////////
// ÂÆπÂô®
//////////////////////////////////////////////////

const leftWall = Bodies.rectangle(centerX - containerWidth/2, bottomY - containerHeight/2, wallThickness, containerHeight, {isStatic:true, render:{fillStyle:"#000"}});
const rightWall = Bodies.rectangle(centerX + containerWidth/2, bottomY - containerHeight/2, wallThickness, containerHeight, {isStatic:true, render:{fillStyle:"#000"}});
const floor = Bodies.rectangle(centerX, bottomY, containerWidth, wallThickness, {isStatic:true, render:{fillStyle:"#000"}});
World.add(world,[leftWall,rightWall,floor]);

//////////////////////////////////////////////////
// üê∂ Áä¨ÁîªÂÉè„Éª„Çµ„Ç§„Ç∫
//////////////////////////////////////////////////

const dogImages = [
  "images/inugame_size1.png",
  "images/inugame_size2.png",
  "images/inugame_size3.png",
  "images/inugame_size4.png",
  "images/inugame_size5.png",
  "images/inugame_size6.png",
  "images/inugame_size7.png",
  "images/inugame_size8.png",
  "images/inugame_size9.png"
];

// ÂÖÉ„Çµ„Ç§„Ç∫
const baseSizes = [18,26,36,48,62,78,100,125,160];
// „Çπ„Éû„ÉõÁâà„ÅØ„Åï„Çâ„Å´Â§ß„Åç„Åè1.5ÂÄç
const sizes = isMobile ? baseSizes.map(s=>Math.round(s*1.5)) : baseSizes;

//////////////////////////////////////////////////
// „Ç≤„Éº„É†Â§âÊï∞
//////////////////////////////////////////////////

let currentBall = null;
let score = 0;
let highScore = localStorage.getItem("highScore") || 0;
let isGameOver = false;
document.getElementById("highScore").innerText = highScore;

//////////////////////////////////////////////////
// „Éú„Éº„É´ÁîüÊàêÈñ¢Êï∞
//////////////////////////////////////////////////

function createBall(sizeIndex, x, y, isStatic=false){
  const radius = sizes[sizeIndex];
  const texturePath = dogImages[sizeIndex];

  // „Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶ÂØÜÂ∫¶Ë™øÊï¥ÔºàÂ∞è„Åï„ÅÑ„Éú„Éº„É´„Åª„Å©Â∞ë„ÅóÈáç„Åè„Åó„Å¶„Åô„ÇäÊäú„ÅëÈò≤Ê≠¢Ôºâ
  const density = sizeIndex === 0 
      ? (isMobile ? 0.006 : 0.003)  // „Çπ„Éû„Éõ„Åß„ÅØÂ∞ë„ÅóÈáç„Åè
      : 0.0015;

  const ball = Bodies.circle(x, y, radius, {
    restitution:0.15,
    friction:0.2,
    density:density,
    isStatic:isStatic,
    render:{
      sprite:{ texture: texturePath, xScale:1, yScale:1 }
    }
  });

  // ÂÖÉÁîªÂÉè„ÅÆÊØîÁéá„Å´Âêà„Çè„Åõ„Å¶„Çπ„Ç±„Éº„É´
  const img = new Image();
  img.src = texturePath;
  img.onload = function(){
    const scale = (radius*2) / Math.max(img.width, img.height);
    ball.render.sprite.xScale = scale;
    ball.render.sprite.yScale = scale;
  };

  ball.sizeIndex = sizeIndex;
  return ball;
}

//////////////////////////////////////////////////
// „Éú„Éº„É´„Çπ„Éù„Éº„É≥
//////////////////////////////////////////////////

function spawnBall(){
  if(isGameOver) return;
  const sizeIndex = Math.floor(Math.random()*3);
  // ÂàùÊúü‰ΩçÁΩÆ„ÇíÂÆπÂô®„Å´Ëøë„Å•„Åë„ÇãÔºà„Çπ„Éû„ÉõÁâàÔºâ
  const startY = isMobile ? bottomY - containerHeight + sizes[sizeIndex] + 20 : 80;
  currentBall = createBall(sizeIndex, centerX, startY, true);
  World.add(world,currentBall);
}

spawnBall();

//////////////////////////////////////////////////
// „Éû„Ç¶„Çπ„Éª„Çø„ÉÉ„ÉÅÊìç‰Ωú
//////////////////////////////////////////////////

function moveBall(clientX){
  if(!currentBall || isGameOver) return;
  const x = Math.max(centerX - containerWidth/2 + 20, Math.min(clientX, centerX + containerWidth/2 - 20));
  Body.setPosition(currentBall,{x:x,y:currentBall.position.y});
}

// PCÁâà„Éû„Ç¶„Çπ
window.addEventListener("mousemove", e => moveBall(e.clientX));
window.addEventListener("click", shootBall);

// „Çπ„Éû„ÉõÁâà„Çø„ÉÉ„ÉÅ
window.addEventListener("touchstart", e => {
  if(e.touches.length>0) moveBall(e.touches[0].clientX);
  e.preventDefault();
});
window.addEventListener("touchmove", e => {
  if(e.touches.length>0) moveBall(e.touches[0].clientX);
  e.preventDefault();
});
window.addEventListener("touchend", e => {
  shootBall();
  e.preventDefault();
});

//////////////////////////////////////////////////
// „Éú„Éº„É´ËêΩ‰∏ã
//////////////////////////////////////////////////

function shootBall(){
  if(isGameOver || !currentBall) return;
  Body.setStatic(currentBall,false);
  currentBall = null;
  setTimeout(spawnBall,350);
}

//////////////////////////////////////////////////
// Âêà‰ΩìÂá¶ÁêÜ
//////////////////////////////////////////////////

Events.on(engine,"collisionStart",event=>{
  event.pairs.forEach(pair=>{
    const a = pair.bodyA;
    const b = pair.bodyB;
    if(a.sizeIndex!==undefined && b.sizeIndex!==undefined && a!==currentBall && b!==currentBall && a.sizeIndex===b.sizeIndex){
      const newSize = (a.sizeIndex < sizes.length-1) ? a.sizeIndex+1 : sizes.length-1;
      const newBall = createBall(
        newSize,
        (a.position.x+b.position.x)/2,
        (a.position.y+b.position.y)/2
      );
      World.remove(world,a);
      World.remove(world,b);
      World.add(world,newBall);

      score += (newSize+1)*5;
      document.getElementById("score").innerText = score;

      if(score>highScore){
        highScore = score;
        localStorage.setItem("highScore",highScore);
        document.getElementById("highScore").innerText = highScore;
      }
    }
  });
});

//////////////////////////////////////////////////
// „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÂà§ÂÆö
//////////////////////////////////////////////////

Events.on(engine,"afterUpdate",()=>{
  if(isGameOver) return;
  world.bodies.forEach(body=>{
    if(body.sizeIndex!==undefined && body.position.y>height+200){
      gameOver();
    }
  });
});

function gameOver(){
  if(isGameOver) return;
  isGameOver = true;
  document.getElementById("gameOver").style.display="block";
  updateRanking();
}

//////////////////////////////////////////////////
// „É™„Éà„É©„Ç§
//////////////////////////////////////////////////

document.getElementById("retryBtn").addEventListener("click",()=>{
  world.bodies.slice().forEach(body=>{ if(body.sizeIndex!==undefined) World.remove(world,body); });
  score=0; document.getElementById("score").innerText=0;
  isGameOver=false;
  document.getElementById("gameOver").style.display="none";
  spawnBall();
});

//////////////////////////////////////////////////
// „É©„É≥„Ç≠„É≥„Ç∞
//////////////////////////////////////////////////

function updateRanking(){
  const today = new Date().toISOString().slice(0,10);
  const key = "ranking_" + today;
  let ranking = JSON.parse(localStorage.getItem(key)||"[]");
  ranking.push(score);
  ranking.sort((a,b)=>b-a);
  ranking = ranking.slice(0,3);
  localStorage.setItem(key,JSON.stringify(ranking));
  const box = document.getElementById("ranking");
  box.innerHTML="";
  ranking.forEach((s,i)=>{ box.innerHTML += `${i+1}‰Ωç : ${s}<br>`; });
}

updateRanking();
</script>
</body>
</html>
