<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Áä¨„Çπ„Ç§„Ç´„Ç≤„Éº„É† üê∂</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
body, html {
  margin:0;
  overflow:hidden;
  width:100%;
  height:100%;
  background:linear-gradient(#ffe8c7,#ffd6a5);
  font-family:sans-serif;
}

#scoreBox{
  position:absolute;
  top:20px;
  right:20px;
  font-size:18px;
  z-index:10;
}

#rankingBox{
  position:absolute;
  top:20px;
  left:20px;
  width:230px;
  font-size:14px;
  line-height:1.6em;
  z-index:10;
  background:rgba(255,255,255,0.7);
  padding:10px;
  border-radius:10px;
}

#gameOver{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  display:none;
  z-index:20;
  background:white;
  padding:20px;
  border-radius:10px;
}

#gameOver h1{
  color:red;
  font-size:40px;
}

button{
  padding:8px 18px;
  font-size:16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#ff595e;
  color:white;
}
</style>
</head>
<body>

<div id="scoreBox">
  Score : <span id="score">0</span><br>
  High : <span id="highScore">0</span>
</div>

<div id="rankingBox">
  <b>üåç ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞ TOP10</b>
  <div id="ranking"></div>
</div>

<div id="gameOver">
  <h1>GAME OVER</h1>
  <input id="playerName" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
  <br><br>
  <button onclick="submitScore()">„Çπ„Ç≥„Ç¢ÈÄÅ‰ø°</button>
  <br><br>
  <button onclick="location.reload()">Retry</button>
</div>

<script>
const {Engine, Render, Runner, World, Bodies, Body, Events} = Matter;

const isMobile = window.innerWidth < 768;
const width = window.innerWidth;
const height = window.innerHeight;

const engine = Engine.create();
engine.world.gravity.y = 1;
const world = engine.world;

const render = Render.create({
  element: document.body,
  engine: engine,
  options:{
    width: width,
    height: height,
    wireframes:false,
    background:"transparent"
  }
});
Render.run(render);
Runner.run(Runner.create(), engine);

// ÂÆπÂô®„Çµ„Ç§„Ç∫
const containerWidth = isMobile ? width*0.9 : 420;
const containerHeight = isMobile ? height*0.6 : 520;
const centerX = width/2;
const bottomY = height*0.9;

const leftWall = Bodies.rectangle(centerX-containerWidth/2, bottomY-containerHeight/2, 10, containerHeight,{isStatic:true});
const rightWall = Bodies.rectangle(centerX+containerWidth/2, bottomY-containerHeight/2, 10, containerHeight,{isStatic:true});
const floor = Bodies.rectangle(centerX, bottomY, containerWidth, 10,{isStatic:true});
World.add(world,[leftWall,rightWall,floor]);

// „Çµ„Ç§„Ç∫Ë™øÊï¥ÔºàPC„Å®„Çπ„Éû„Éõ„ÅßÂ§â„Åà„ÇãÔºâ
const baseSizes=[18,26,36,48,62,78,100,125,160];
const sizeMultiplier = isMobile ? 0.75 : 0.6;
const sizes = baseSizes.map(s=>Math.round(s*sizeMultiplier));

const dogImages=[
"images/inugame_size1.png",
"images/inugame_size2.png",
"images/inugame_size3.png",
"images/inugame_size4.png",
"images/inugame_size5.png",
"images/inugame_size6.png",
"images/inugame_size7.png",
"images/inugame_size8.png",
"images/inugame_size9.png"
];

let currentBall=null;
let score=0;
let highScore=localStorage.getItem("highScore")||0;
let isGameOver=false;
document.getElementById("highScore").innerText=highScore;

function createBall(sizeIndex,x,y,isStatic=false){
  const radius=sizes[sizeIndex];
  const texturePath=dogImages[sizeIndex];

  const ball=Bodies.circle(x,y,radius,{
    restitution:0.15,
    friction:0.2,
    isStatic:isStatic,
    render:{sprite:{texture:texturePath,xScale:1,yScale:1}}
  });

  const img=new Image();
  img.src=texturePath;
  img.onload=function(){
    const scale=(radius*2)/Math.max(img.width,img.height);
    ball.render.sprite.xScale=scale;
    ball.render.sprite.yScale=scale;
  };

  ball.sizeIndex=sizeIndex;
  return ball;
}

function spawnBall(){
  if(isGameOver) return;
  const sizeIndex=Math.floor(Math.random()*3);
  currentBall=createBall(sizeIndex,centerX,100,true);
  World.add(world,currentBall);
}
spawnBall();

window.addEventListener("mousemove",e=>{
  if(currentBall && !isGameOver){
    Body.setPosition(currentBall,{x:e.clientX,y:100});
  }
});

window.addEventListener("click",()=>{
  if(currentBall && !isGameOver){
    Body.setStatic(currentBall,false);
    currentBall=null;
    setTimeout(spawnBall,400);
  }
});

Events.on(engine,"collisionStart",event=>{
  event.pairs.forEach(pair=>{
    const a=pair.bodyA;
    const b=pair.bodyB;
    if(a.sizeIndex!==undefined && b.sizeIndex!==undefined && a.sizeIndex===b.sizeIndex){
      const newSize=a.sizeIndex+1;
      if(newSize<sizes.length){
        const newBall=createBall(newSize,(a.position.x+b.position.x)/2,(a.position.y+b.position.y)/2);
        World.remove(world,a);
        World.remove(world,b);
        World.add(world,newBall);
        score+=(newSize+1)*5;
        document.getElementById("score").innerText=score;

        if(score>highScore){
          highScore=score;
          localStorage.setItem("highScore",highScore);
          document.getElementById("highScore").innerText=highScore;
        }
      }
    }
  });
});

Events.on(engine,"afterUpdate",()=>{
  if(isGameOver) return;
  world.bodies.forEach(body=>{
    if(body.sizeIndex!==undefined && body.position.y>height+200){
      isGameOver=true;
      document.getElementById("gameOver").style.display="block";
    }
  });
});
</script>

<!-- üî• ‰∏ñÁïå„É©„É≥„Ç≠„É≥„Ç∞ÔºàFirebaseÔºâ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onValue, query, orderByChild, limitToLast }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig={
  apiKey:"AIzaSyDzxYXP5Lyz1Ky-q1S1hJO746gIU6VaAy8",
  authDomain:"shibainugame-1865a.firebaseapp.com",
  databaseURL:"https://shibainugame-1865a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"shibainugame-1865a",
  storageBucket:"shibainugame-1865a.firebasestorage.app",
  messagingSenderId:"278247707611",
  appId:"1:278247707611:web:9a04085c0493fd2ee64dfe"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

window.submitScore=function(){
  const name=document.getElementById("playerName").value||"ÂêçÁÑ°„Åó";
  push(ref(db,"ranking"),{
    name:name,
    score:score,
    time:Date.now()
  });
};

const rankingRef=query(ref(db,"ranking"),orderByChild("score"),limitToLast(10));

onValue(rankingRef,(snapshot)=>{
  const box=document.getElementById("ranking");
  box.innerHTML="";
  const data=[];
  snapshot.forEach(child=>data.push(child.val()));
  data.reverse();
  data.forEach((item,i)=>{
    if(i===0){
      box.innerHTML+="üèÜ <span style='color:gold'>"+item.name+" - "+item.score+"</span><br>";
    }else{
      box.innerHTML+=(i+1)+"‰Ωç "+item.name+" - "+item.score+"<br>";
    }
  });
});
</script>

</body>
</html>
